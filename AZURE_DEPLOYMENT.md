# Azure Windows VM Deployment Guide

Complete guide for deploying Formulation Graph Studio on Azure Windows VM with OLLAMA and Neo4j.

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Azure VM Setup](#azure-vm-setup)
3. [Install Dependencies](#install-dependencies)
4. [Configure Services](#configure-services)
5. [Deploy Application](#deploy-application)
6. [Configure as Windows Service](#configure-as-windows-service)
7. [Network Configuration](#network-configuration)
8. [Testing](#testing)
9. [Troubleshooting](#troubleshooting)

## Prerequisites

### Azure Resources
- Azure subscription
- Windows Server 2019/2022 VM or Windows 10/11 Pro VM
- Recommended VM size: Standard_D4s_v3 (4 vCPU, 16 GB RAM) or higher
- Public IP address (for external access)
- Network Security Group configured

### Required Software
- Python 3.10 or higher
- OLLAMA (local AI service)
- Neo4j (cloud or local)
- Git (optional, for version control)

## Azure VM Setup

### 1. Create Windows VM

#### Via Azure Portal

1. Navigate to Azure Portal (https://portal.azure.com)
2. Click "Create a resource" > "Virtual Machine"
3. Configure:
   - **Basics**:
     - Resource Group: Create new or use existing
     - VM Name: `formulation-api-vm`
     - Region: Choose nearest to users
     - Image: Windows Server 2022 Datacenter
     - Size: Standard_D4s_v3 (or larger)
     - Username: `azureuser` (or preferred)
     - Password: Strong password (save securely)
   - **Disks**:
     - OS Disk: Premium SSD, 128 GB minimum
   - **Networking**:
     - Create new VNet or use existing
     - Public IP: Yes
     - NIC NSG: Create new
     - Inbound ports: RDP (3389), HTTP (80), HTTPS (443), Custom (8000)
   - **Management**:
     - Auto-shutdown: Configure as needed
4. Review and Create

#### Via Azure CLI

```bash
# Create resource group
az group create --name formulation-rg --location eastus

# Create VM
az vm create \
  --resource-group formulation-rg \
  --name formulation-api-vm \
  --image Win2022Datacenter \
  --size Standard_D4s_v3 \
  --admin-username azureuser \
  --admin-password <YourStrongPassword>

# Open ports
az vm open-port --port 3389 --resource-group formulation-rg --name formulation-api-vm --priority 1000
az vm open-port --port 8000 --resource-group formulation-rg --name formulation-api-vm --priority 1010
```

### 2. Connect to VM

#### Via RDP

1. Download RDP file from Azure Portal
2. Open with Remote Desktop Connection
3. Enter credentials
4. Accept certificate warning

#### Get Public IP

```bash
az vm list-ip-addresses --resource-group formulation-rg --name formulation-api-vm --output table
```

## Install Dependencies

### 1. Install Python

Open PowerShell as Administrator:

```powershell
# Option A: Using winget (Windows 10+)
winget install Python.Python.3.11

# Option B: Manual download
# Download from https://www.python.org/downloads/
# Run installer, check "Add Python to PATH"

# Verify installation
python --version
pip --version
```

### 2. Install OLLAMA

```powershell
# Download OLLAMA installer
# Visit https://ollama.ai/download and download Windows installer

# Or use winget
winget install Ollama.Ollama

# Verify installation
ollama --version

# Pull AI model
ollama pull llama2

# Verify model
ollama list
```

### 3. Install Git (Optional)

```powershell
winget install Git.Git

# Verify
git --version
```

### 4. Install NSSM (for Windows Service)

```powershell
# Option A: Using Chocolatey
# Install Chocolatey first if not installed
Set-ExecutionPolicy Bypass -Scope Process -Force
[System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))

# Install NSSM
choco install nssm -y

# Option B: Manual download
# Download from https://nssm.cc/download
# Extract to C:\Program Files\nssm
# Add to PATH: C:\Program Files\nssm\win64
```

## Configure Services

### 1. Start OLLAMA Service

```powershell
# OLLAMA should start automatically after installation
# Check if running
curl http://localhost:11434/api/tags

# If not running, start manually
ollama serve

# Configure to start on boot (should be automatic after installation)
# Verify in Services (services.msc) - look for "Ollama"
```

### 2. Configure Neo4j

#### Option A: Use Neo4j Aura (Cloud - Recommended)

1. Sign up at https://neo4j.com/cloud/aura/
2. Create free instance
3. Note:
   - Connection URI (e.g., `neo4j+s://xxxxx.databases.neo4j.io`)
   - Username (usually `neo4j`)
   - Password (generated by Aura)
4. Test connection from Neo4j Browser

#### Option B: Install Neo4j Desktop (Local)

```powershell
# Download Neo4j Desktop
# Visit https://neo4j.com/download/

# Install and create database
# Note connection details:
# - URI: bolt://localhost:7687 or neo4j://localhost:7687
# - Username: neo4j
# - Password: (set during creation)
```

#### Option C: Neo4j Docker (Local)

```powershell
# Install Docker Desktop for Windows
winget install Docker.DockerDesktop

# Run Neo4j container
docker run `
  --name neo4j `
  -p 7474:7474 -p 7687:7687 `
  -e NEO4J_AUTH=neo4j/your-password `
  -v C:\neo4j-data:/data `
  neo4j:latest

# Configure to start on boot
# Docker Desktop > Settings > General > Start Docker Desktop when you log in
```

## Deploy Application

### 1. Create Application Directory

```powershell
# Create directory
New-Item -Path "C:\Apps" -ItemType Directory -Force
cd C:\Apps

# Clone repository (if using Git)
git clone <your-repository-url> formulation-graph-studio
cd formulation-graph-studio\backend

# Or manually copy files to C:\Apps\formulation-graph-studio\backend
```

### 2. Run Setup Script

```powershell
cd C:\Apps\formulation-graph-studio\backend

# Run setup
.\setup-backend.bat
```

### 3. Configure Environment

Edit `.env` file:

```powershell
notepad .env
```

Update with your configuration:

```env
# Server Configuration
HOST=0.0.0.0
PORT=8000
DEBUG=False

# Neo4j Configuration (Use your actual values)
NEO4J_URI=neo4j+s://xxxxx.databases.neo4j.io
NEO4J_USER=neo4j
NEO4J_PASSWORD=your-actual-password
NEO4J_DATABASE=neo4j

# OLLAMA Configuration
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=llama2
OLLAMA_TIMEOUT=60

# AI Service
AI_SERVICE_MODE=auto
AI_RETRY_ATTEMPTS=3
AI_TIMEOUT_SECONDS=30
```

### 4. Test Manual Start

```powershell
# Test the application
.\start-backend.bat

# In another PowerShell window, test the API
curl http://localhost:8000/health
curl http://localhost:8000/api/health

# If successful, press Ctrl+C to stop
```

## Configure as Windows Service

### Method 1: Using NSSM (Recommended)

```powershell
# Open PowerShell as Administrator

# Navigate to backend directory
cd C:\Apps\formulation-graph-studio\backend

# Get Python executable path
$pythonPath = (Get-Command python).Source
# Should be something like: C:\Users\azureuser\AppData\Local\Programs\Python\Python311\python.exe
# Or from venv: C:\Apps\formulation-graph-studio\backend\venv\Scripts\python.exe

# Create Windows Service
nssm install FormulationAPI "C:\Apps\formulation-graph-studio\backend\venv\Scripts\python.exe"
nssm set FormulationAPI AppParameters "C:\Apps\formulation-graph-studio\backend\main.py"
nssm set FormulationAPI AppDirectory "C:\Apps\formulation-graph-studio\backend"
nssm set FormulationAPI DisplayName "Formulation Graph Studio API"
nssm set FormulationAPI Description "Food & Beverage Formulation Management API with OLLAMA and Neo4j"
nssm set FormulationAPI Start SERVICE_AUTO_START

# Set environment file
nssm set FormulationAPI AppEnvironmentExtra "PYTHONUNBUFFERED=1"

# Configure service dependencies (start after OLLAMA)
nssm set FormulationAPI DependOnService "Ollama"

# Configure logging
nssm set FormulationAPI AppStdout "C:\Apps\formulation-graph-studio\backend\logs\service-output.log"
nssm set FormulationAPI AppStderr "C:\Apps\formulation-graph-studio\backend\logs\service-error.log"
nssm set FormulationAPI AppRotateFiles 1
nssm set FormulationAPI AppRotateBytes 1048576

# Create logs directory
New-Item -Path "C:\Apps\formulation-graph-studio\backend\logs" -ItemType Directory -Force

# Start the service
nssm start FormulationAPI

# Check service status
nssm status FormulationAPI
Get-Service FormulationAPI

# View logs
Get-Content C:\Apps\formulation-graph-studio\backend\logs\service-output.log -Tail 20
```

### Method 2: Using Task Scheduler

```powershell
# Create startup task
$action = New-ScheduledTaskAction -Execute "C:\Apps\formulation-graph-studio\backend\venv\Scripts\python.exe" -Argument "C:\Apps\formulation-graph-studio\backend\main.py" -WorkingDirectory "C:\Apps\formulation-graph-studio\backend"

$trigger = New-ScheduledTaskTrigger -AtStartup

$principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest

$settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable -RestartCount 3 -RestartInterval (New-TimeSpan -Minutes 1)

Register-ScheduledTask -TaskName "FormulationAPI" -Action $action -Trigger $trigger -Principal $principal -Settings $settings -Description "Formulation Graph Studio API Service"

# Start task
Start-ScheduledTask -TaskName "FormulationAPI"

# Check status
Get-ScheduledTask -TaskName "FormulationAPI" | Get-ScheduledTaskInfo
```

### Service Management Commands

```powershell
# Start service
Start-Service FormulationAPI
# Or with NSSM
nssm start FormulationAPI

# Stop service
Stop-Service FormulationAPI
# Or
nssm stop FormulationAPI

# Restart service
Restart-Service FormulationAPI
# Or
nssm restart FormulationAPI

# Check status
Get-Service FormulationAPI
# Or
nssm status FormulationAPI

# View service properties
nssm dump FormulationAPI

# Remove service (if needed)
nssm remove FormulationAPI confirm
```

## Network Configuration

### 1. Configure Windows Firewall

```powershell
# Open PowerShell as Administrator

# Allow inbound traffic on port 8000
New-NetFirewallRule -DisplayName "Formulation API" -Direction Inbound -LocalPort 8000 -Protocol TCP -Action Allow

# Verify rule
Get-NetFirewallRule -DisplayName "Formulation API" | Format-Table -Property DisplayName, Enabled, Direction, Action
```

### 2. Configure Azure Network Security Group

#### Via Azure Portal

1. Navigate to VM > Networking
2. Click "Add inbound port rule"
3. Configure:
   - Source: Any (or specific IP ranges for security)
   - Source port ranges: *
   - Destination: Any
   - Destination port ranges: 8000
   - Protocol: TCP
   - Action: Allow
   - Priority: 1010
   - Name: AllowAPITraffic
4. Save

#### Via Azure CLI

```bash
az network nsg rule create \
  --resource-group formulation-rg \
  --nsg-name <your-nsg-name> \
  --name AllowAPITraffic \
  --priority 1010 \
  --source-address-prefixes '*' \
  --source-port-ranges '*' \
  --destination-address-prefixes '*' \
  --destination-port-ranges 8000 \
  --access Allow \
  --protocol Tcp \
  --description "Allow Formulation API traffic"
```

### 3. Configure Frontend Connection

Update frontend configuration to point to VM:

```javascript
// In frontend .env or config
VITE_API_BASE_URL=http://<VM-PUBLIC-IP>:8000
```

## Testing

### 1. Test from VM (Localhost)

```powershell
# Health check
curl http://localhost:8000/health
curl http://localhost:8000/api/health

# Test AI service
curl -X POST http://localhost:8000/api/ai/query `
  -H "Content-Type: application/json" `
  -d '{"query": "Show all formulations", "service_mode": "auto"}'
```

### 2. Test from External Network

```powershell
# Get VM public IP
$publicIP = (az vm list-ip-addresses --resource-group formulation-rg --name formulation-api-vm --query "[0].virtualMachine.network.publicIpAddresses[0].ipAddress" -o tsv)

# Test from another machine
curl http://${publicIP}:8000/health
```

### 3. Load Sample Data

```powershell
curl -X POST http://localhost:8000/api/sample-data/load `
  -H "Content-Type: application/json" `
  -d '{"clear_existing": true, "datasets": ["all"]}'
```

### 4. Access API Documentation

Open browser:
- Swagger UI: http://<VM-PUBLIC-IP>:8000/docs
- ReDoc: http://<VM-PUBLIC-IP>:8000/redoc

## Troubleshooting

### Service Not Starting

```powershell
# Check service status
nssm status FormulationAPI

# View logs
Get-Content C:\Apps\formulation-graph-studio\backend\logs\service-error.log -Tail 50

# Check if port is in use
netstat -ano | findstr :8000

# Test manual start
cd C:\Apps\formulation-graph-studio\backend
.\venv\Scripts\activate
python main.py
```

### OLLAMA Not Responding

```powershell
# Check OLLAMA service
Get-Service Ollama

# Test OLLAMA
curl http://localhost:11434/api/tags

# Restart OLLAMA service
Restart-Service Ollama

# Or restart from Task Manager > Services
```

### Neo4j Connection Failed

```powershell
# Verify credentials in .env
notepad .env

# Test connection with Neo4j Browser
# Navigate to https://workspace.neo4j.io/

# Check firewall
# Ensure port 7687 is allowed if using local Neo4j
```

### Cannot Access from External Network

```powershell
# Check Windows Firewall
Get-NetFirewallRule -DisplayName "Formulation API"

# Check Azure NSG rules
az network nsg rule list --resource-group formulation-rg --nsg-name <your-nsg-name> --output table

# Verify VM is running
az vm get-instance-view --resource-group formulation-rg --name formulation-api-vm --query instanceView.statuses[1] --output table

# Get public IP
az vm list-ip-addresses --resource-group formulation-rg --name formulation-api-vm --output table
```

### High CPU/Memory Usage

```powershell
# Check resource usage
Get-Process python | Select-Object CPU, PM, WS

# Consider using smaller OLLAMA model
ollama pull mistral
# Update OLLAMA_MODEL=mistral in .env

# Restart service
Restart-Service FormulationAPI
```

## Maintenance

### Update Application

```powershell
# Stop service
Stop-Service FormulationAPI

# Navigate to app directory
cd C:\Apps\formulation-graph-studio

# Pull latest changes (if using Git)
git pull

# Or manually replace files

# Update dependencies
cd backend
.\venv\Scripts\activate
pip install -r requirements.txt --upgrade

# Restart service
Start-Service FormulationAPI
```

### View Logs

```powershell
# Service logs
Get-Content C:\Apps\formulation-graph-studio\backend\logs\service-output.log -Tail 50 -Wait

# Application logs (if using file logging)
Get-Content C:\Apps\formulation-graph-studio\backend\logs\app.log -Tail 50 -Wait
```

### Backup Configuration

```powershell
# Backup .env file
Copy-Item C:\Apps\formulation-graph-studio\backend\.env C:\Backups\env-backup-$(Get-Date -Format 'yyyyMMdd').env
```

## Security Best Practices

1. **Change Default Passwords**: Update Neo4j and VM passwords
2. **Restrict NSG Rules**: Limit source IP ranges to known networks
3. **Enable HTTPS**: Use reverse proxy (IIS/nginx) with SSL certificate
4. **Regular Updates**: Keep Python, OLLAMA, and dependencies updated
5. **Monitor Logs**: Regularly review application and service logs
6. **Backup Data**: Regular backups of Neo4j database and configuration
7. **Use Secrets Management**: Consider Azure Key Vault for sensitive data

## Additional Resources

- [Azure Virtual Machines Documentation](https://docs.microsoft.com/azure/virtual-machines/)
- [OLLAMA Documentation](https://ollama.ai/docs)
- [Neo4j Documentation](https://neo4j.com/docs/)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [NSSM Documentation](https://nssm.cc/)

## Support

For issues or questions:
- Review logs in `C:\Apps\formulation-graph-studio\backend\logs\`
- Check service status: `Get-Service FormulationAPI`
- Verify all services are running (OLLAMA, Neo4j)
- API Documentation: http://localhost:8000/docs
